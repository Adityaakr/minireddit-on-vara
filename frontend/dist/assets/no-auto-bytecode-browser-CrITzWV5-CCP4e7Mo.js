class R extends Error{constructor(r){super(r),this.name="AddChainError"}}class x extends Error{constructor(){super(),this.name="AlreadyDestroyedError"}}class S extends Error{constructor(){super(),this.name="JsonRpcDisabledError"}}class _ extends Error{constructor(r){super(r)}}class T extends Error{constructor(){super("JSON-RPC requests queue is full")}}function b(a,r,d){return I(a,r,d),new TextDecoder().decode(a.slice(r,r+d))}function M(a,r){return I(a,r,1),a[r]}function g(a,r){return I(a,r,2),a[r]<<8|a[r+1]}function v(a,r){return I(a,r,4),(a[r]|a[r+1]<<8|a[r+2]<<16)+a[r+3]*16777216}function A(a,r,d){I(a,r,1),a[r]=d&255}function j(a,r,d){I(a,r,4),a[r+3]=d>>>24&255,a[r+2]=d>>>16&255,a[r+1]=d>>>8&255,a[r]=d&255}function I(a,r,d){if(!Number.isInteger(r)||r<0)throw new RangeError;if(r+d>a.length)throw new RangeError}var k=function(a,r,d,o){function h(n){return n instanceof d?n:new d(function(l){l(n)})}return new(d||(d=Promise))(function(n,l){function t(c){try{s(o.next(c))}catch(i){l(i)}}function e(c){try{s(o.throw(c))}catch(i){l(i)}}function s(c){c.done?n(c.value):h(c.value).then(t,e)}s((o=o.apply(a,[])).next())})};function L(a,r,d){return k(this,void 0,void 0,function*(){const o={instance:null,currentTask:null,bufferIndices:new Array,advanceExecutionPromise:null,onShutdownExecutorOrWasmPanic:()=>{}},h={panic:(t,e)=>{const s=o.instance;o.instance=null,t>>>=0,e>>>=0;const c=b(new Uint8Array(s.exports.memory.buffer),t,e);throw d({ty:"wasm-panic",message:c,currentTask:o.currentTask}),o.onShutdownExecutorOrWasmPanic(),o.onShutdownExecutorOrWasmPanic=()=>{},new Error("Smoldot has panicked")},chain_initialized:(t,e,s)=>{const c=o.instance,i=new Uint8Array(c.exports.memory.buffer);if(e>>>=0,s>>>=0,e===0)d({ty:"add-chain-result",chainId:t,success:!0});else{const u=b(i,e,s);d({ty:"add-chain-result",chainId:t,success:!1,error:u})}},random_get:(t,e)=>{const s=o.instance;t>>>=0,e>>>=0;const c=new Uint8Array(s.exports.memory.buffer).subarray(t,t+e);for(let i=0;i<e;i+=65536)a.getRandomValues(c.subarray(i,i+65536))},unix_timestamp_us:()=>{const t=Math.floor(Date.now());if(t<0)throw new Error("UNIX timestamp inferior to 0");return BigInt(t)*BigInt(1e3)},monotonic_clock_us:()=>{const t=a.performanceNow(),e=Math.floor(t);return BigInt(e)*BigInt(1e3)+BigInt(Math.floor((t-e)*1e3))},buffer_size:t=>o.bufferIndices[t].byteLength,buffer_copy:(t,e)=>{const s=o.instance;e=e>>>0;const c=o.bufferIndices[t];new Uint8Array(s.exports.memory.buffer).set(c,e)},advance_execution_ready:()=>{o.advanceExecutionPromise&&o.advanceExecutionPromise(),o.advanceExecutionPromise=null},json_rpc_responses_non_empty:t=>{d({ty:"json-rpc-responses-non-empty",chainId:t})},log:(t,e,s,c,i)=>{const u=o.instance;e>>>=0,s>>>=0,c>>>=0,i>>>=0;const f=new Uint8Array(u.exports.memory.buffer);let p=b(f,e,s),m=b(f,c,i);d({ty:"log",level:t,message:m,target:p})},start_timer:t=>{const e=o.instance;t>2147483647&&(t=2147483647),t<1&&typeof setImmediate=="function"?setImmediate(()=>{if(o.instance)try{e.exports.timer_finished()}catch{}}):setTimeout(()=>{if(o.instance)try{e.exports.timer_finished()}catch{}},t)},connection_type_supported:t=>{switch(t){case 0:case 1:case 2:return a.forbidTcp?0:1;case 4:case 5:case 6:return a.forbidWs||a.forbidNonLocalWs?0:1;case 7:return a.forbidWs?0:1;case 14:return a.forbidWss?0:1;case 16:case 17:return a.forbidWebRtc?0:1;default:throw new Error("Invalid connection type passed to `connection_type_supported`")}},connection_new:(t,e,s)=>{const c=o.instance,i=new Uint8Array(c.exports.memory.buffer);e>>>=0,s>>>=0;let u;switch(M(i,e)){case 0:case 1:case 2:{const f=g(i,e+1),p=b(i,e+3,s-3);u={ty:"tcp",port:f,hostname:p};break}case 4:case 6:{const f=g(i,e+1);u={ty:"websocket",url:"ws://"+b(i,e+3,s-3)+":"+f};break}case 5:{const f=g(i,e+1);u={ty:"websocket",url:"ws://["+b(i,e+3,s-3)+"]:"+f};break}case 14:{const f=g(i,e+1);u={ty:"websocket",url:"wss://"+b(i,e+3,s-3)+":"+f};break}case 16:{const f=g(i,e+1),p=i.slice(e+3,e+35),m=b(i,e+35,s-35);u={ty:"webrtc",ipVersion:"4",remoteTlsCertificateSha256:p,targetIp:m,targetPort:f};break}case 17:{const f=g(i,e+1),p=i.slice(e+3,e+35),m=b(i,e+35,s-35);u={ty:"webrtc",ipVersion:"6",remoteTlsCertificateSha256:p,targetIp:m,targetPort:f};break}default:throw new Error("Invalid encoded address passed to `connection_new`")}d({ty:"new-connection",connectionId:t,address:u})},reset_connection:t=>{d({ty:"connection-reset",connectionId:t})},connection_stream_open:t=>{d({ty:"connection-stream-open",connectionId:t})},connection_stream_reset:(t,e)=>{d({ty:"connection-stream-reset",connectionId:t,streamId:e})},stream_send:(t,e,s,c)=>{const i=o.instance,u=new Uint8Array(i.exports.memory.buffer);s>>>=0,c>>>=0;const f=new Array;for(let p=0;p<c;++p){const m=v(u,s+8*p),w=v(u,s+8*p+4);f.push(u.slice(m,m+w))}d({ty:"stream-send",connectionId:t,streamId:e,data:f})},stream_send_close:(t,e)=>{d({ty:"stream-send-close",connectionId:t,streamId:e})},current_task_entered:(t,e)=>{t>>>=0,e>>>=0;const s=b(new Uint8Array(o.instance.exports.memory.buffer),t,e);o.currentTask=s},current_task_exit:()=>{o.currentTask=null}},n=yield WebAssembly.instantiate(r,{smoldot:h});o.instance=n,o.instance.exports.init(a.maxLogLevel);const l=new Promise(t=>o.onShutdownExecutorOrWasmPanic=()=>t("stop"));return k(this,void 0,void 0,function*(){const t=a.cpuRateLimit;let e=0,s=a.performanceNow();for(;;){const c=new Promise(m=>o.advanceExecutionPromise=()=>m("ready"));if(!o.instance)break;try{o.instance.exports.advance_execution()}catch{return}const i=a.performanceNow(),u=i-s;s=i;const f=u*(1/t-1);if(e+=f,e>5){e>2147483646&&(e=2147483646);const m=new Promise(w=>setTimeout(()=>w("timeout"),e));if((yield Promise.race([m,l]))==="stop")break}if((yield Promise.race([c,l]))==="stop")break;const p=a.performanceNow();e-=p-s,e<-1e4&&(e=-1e4),s=p}o.instance&&d({ty:"executor-shutdown"})}),{request:(t,e)=>o.instance?(o.bufferIndices[0]=new TextEncoder().encode(t),o.instance.exports.json_rpc_send(0,e)>>>0):1,peekJsonRpcResponse:t=>{if(!o.instance)return null;const e=o.instance.exports.json_rpc_responses_peek(t)>>>0,s=new Uint8Array(o.instance.exports.memory.buffer),c=v(s,e)>>>0,i=v(s,e+4)>>>0;if(i!==0){const u=b(s,c,i);return o.instance.exports.json_rpc_responses_pop(t),u}else return null},addChain:(t,e,s,c,i,u)=>{if(!o.instance){d({ty:"add-chain-id-allocated",chainId:0}),d({ty:"add-chain-result",chainId:0,success:!1,error:"Smoldot has crashed"});return}console.assert(c||i!=0,"invalid jsonRpcMaxPendingRequests value passed to local-instance::addChain"),o.bufferIndices[0]=new TextEncoder().encode(t),o.bufferIndices[1]=new TextEncoder().encode(e);const f=new Uint8Array(s.length*4);for(let m=0;m<s.length;++m)j(f,m*4,s[m]);o.bufferIndices[2]=f;let p;try{p=o.instance.exports.add_chain(0,1,c?0:i,u,2)}catch{d({ty:"add-chain-id-allocated",chainId:0}),d({ty:"add-chain-result",chainId:0,success:!1,error:"Smoldot has crashed"});return}delete o.bufferIndices[0],delete o.bufferIndices[1],delete o.bufferIndices[2],d({ty:"add-chain-id-allocated",chainId:p})},removeChain:t=>{if(o.instance)try{o.instance.exports.remove_chain(t)}catch{return}},shutdownExecutor:()=>{if(!o.instance)return;const t=o.onShutdownExecutorOrWasmPanic;o.onShutdownExecutorOrWasmPanic=()=>{},t()},connectionMultiStreamSetHandshakeInfo:(t,e)=>{if(!o.instance)return;const s=new Uint8Array(1+e.localTlsCertificateSha256.length);A(s,0,0),s.set(e.localTlsCertificateSha256,1),o.bufferIndices[0]=s,o.instance.exports.connection_multi_stream_set_handshake_info(t,0),delete o.bufferIndices[0]},connectionReset:(t,e)=>{o.instance&&(o.bufferIndices[0]=new TextEncoder().encode(e),o.instance.exports.connection_reset(t,0),delete o.bufferIndices[0])},streamWritableBytes:(t,e,s)=>{o.instance&&o.instance.exports.stream_writable_bytes(t,s||0,e)},streamMessage:(t,e,s)=>{o.instance&&(o.bufferIndices[0]=e,o.instance.exports.stream_message(t,s||0,0),delete o.bufferIndices[0])},streamOpened:(t,e,s)=>{o.instance&&o.instance.exports.connection_stream_opened(t,e,s==="outbound"?1:0)},streamReset:(t,e,s)=>{o.instance&&(o.bufferIndices[0]=new TextEncoder().encode(s),o.instance.exports.stream_reset(t,e,0),delete o.bufferIndices[0])}}})}var E=function(a,r,d,o){function h(n){return n instanceof d?n:new d(function(l){l(n)})}return new(d||(d=Promise))(function(n,l){function t(c){try{s(o.next(c))}catch(i){l(i)}}function e(c){try{s(o.throw(c))}catch(i){l(i)}}function s(c){c.done?n(c.value):h(c.value).then(t,e)}s((o=o.apply(a,[])).next())})};function O(a){return E(this,void 0,void 0,function*(){const{port1:r,port2:d}=new MessageChannel,o=a.portToServer,h={wasmModule:yield a.wasmModule,serverToClient:d,maxLogLevel:a.maxLogLevel,cpuRateLimit:a.cpuRateLimit,forbidWs:a.forbidWs,forbidWss:a.forbidWss,forbidNonLocalWs:a.forbidNonLocalWs,forbidTcp:a.forbidTcp,forbidWebRtc:a.forbidWebRtc};o.postMessage(h,[d]);const n={jsonRpcResponses:new Map,connections:new Map};return r.onmessage=l=>{const t=l.data;switch(t.ty){case"wasm-panic":case"executor-shutdown":{r.close(),o.close();break}case"add-chain-result":{if(t.success){n.jsonRpcResponses.set(t.chainId,new Array);const e={ty:"accept-more-json-rpc-answers",chainId:t.chainId};for(let s=0;s<10;++s)r.postMessage(e)}break}case"new-connection":{n.connections.set(t.connectionId,new Set);break}case"connection-reset":{if(!n.connections.has(t.connectionId))return;n.connections.delete(t.connectionId);break}case"connection-stream-open":{if(!n.connections.has(t.connectionId))return;break}case"connection-stream-reset":{if(!n.connections.has(t.connectionId)||!n.connections.get(t.connectionId).has(t.streamId))return;break}case"stream-send":{if(!n.connections.has(t.connectionId)||t.streamId&&!n.connections.get(t.connectionId).has(t.streamId))return;break}case"stream-send-close":{if(!n.connections.has(t.connectionId)||t.streamId&&!n.connections.get(t.connectionId).has(t.streamId))return;break}case"json-rpc-response":{const e=n.jsonRpcResponses.get(t.chainId);e&&(e.push(t.response),a.eventCallback({ty:"json-rpc-responses-non-empty",chainId:t.chainId}));return}}a.eventCallback(t)},{addChain(l,t,e,s,c,i){return E(this,void 0,void 0,function*(){const u={ty:"add-chain",chainSpec:l,databaseContent:t,potentialRelayChains:e,disableJsonRpc:s,jsonRpcMaxPendingRequests:c,jsonRpcMaxSubscriptions:i};r.postMessage(u)})},removeChain(l){n.jsonRpcResponses.delete(l);const t={ty:"remove-chain",chainId:l};r.postMessage(t)},request(l,t){const e={ty:"request",chainId:t,request:l};return r.postMessage(e),0},peekJsonRpcResponse(l){const t=n.jsonRpcResponses.get(l).shift();if(!t)return null;const e={ty:"accept-more-json-rpc-answers",chainId:l};return r.postMessage(e),t},shutdownExecutor(){const l={ty:"shutdown"};r.postMessage(l)},connectionReset(l,t){n.connections.delete(l);const e={ty:"connection-reset",connectionId:l,message:t};r.postMessage(e)},connectionMultiStreamSetHandshakeInfo(l,t){const e={ty:"connection-multistream-set-info",connectionId:l,info:t};r.postMessage(e)},streamMessage(l,t,e){const s={ty:"stream-message",connectionId:l,message:t,streamId:e};r.postMessage(s)},streamOpened(l,t,e){n.connections.get(l).add(t);const s={ty:"stream-opened",connectionId:l,streamId:t,direction:e};r.postMessage(s)},streamWritableBytes(l,t,e){const s={ty:"stream-writable-bytes",connectionId:l,numExtra:t,streamId:e};r.postMessage(s)},streamReset(l,t,e){n.connections.get(l).delete(t);const s={ty:"stream-reset",connectionId:l,streamId:t,message:e};r.postMessage(s)}}})}var C=function(a,r,d,o){function h(n){return n instanceof d?n:new d(function(l){l(n)})}return new(d||(d=Promise))(function(n,l){function t(c){try{s(o.next(c))}catch(i){l(i)}}function e(c){try{s(o.throw(c))}catch(i){l(i)}}function s(c){c.done?n(c.value):h(c.value).then(t,e)}s((o=o.apply(a,[])).next())})};function B(a,r,d){const o=a.logCallback||((e,s,c)=>{e<=1?console.error("[%s] %s",s,c):e==2?console.warn("[%s] %s",s,c):e==3?console.info("[%s] %s",s,c):e==4?console.debug("[%s] %s",s,c):console.trace("[%s] %s",s,c)});r instanceof Promise||(r=Promise.resolve(r));let h=a.cpuRateLimit||1;isNaN(h)&&(h=1),h>1&&(h=1),h<0&&(h=0);const n={instance:{status:"not-created"},chainIds:new WeakMap,connections:new Map,addChainIdAllocations:[],addChainResults:new Map,onExecutorShutdownOrWasmPanic:()=>{},chains:new Map},l=e=>{switch(e.ty){case"wasm-panic":{console.error("Smoldot has panicked"+(e.currentTask?" while executing task `"+e.currentTask+"`":"")+`. This is a bug in smoldot. Please open an issue at https://github.com/smol-dot/smoldot/issues with the following message:
`+e.message),n.instance={status:"destroyed",error:new _(e.message)},n.connections.forEach(c=>c.reset()),n.connections.clear();for(const c of n.addChainIdAllocations)c({success:!1,error:"Smoldot has crashed"});n.addChainIdAllocations=[],n.addChainResults.forEach(c=>{c({success:!1,error:"Smoldot has crashed"})}),n.addChainResults.clear();for(const c of Array.from(n.chains.values())){for(const i of c.jsonRpcResponsesPromises)i();c.jsonRpcResponsesPromises=[]}n.chains.clear();const s=n.onExecutorShutdownOrWasmPanic;n.onExecutorShutdownOrWasmPanic=()=>{},s();break}case"executor-shutdown":{const s=n.onExecutorShutdownOrWasmPanic;n.onExecutorShutdownOrWasmPanic=()=>{},s();break}case"log":{o(e.level,e.target,e.message);break}case"add-chain-id-allocated":{const s=n.addChainIdAllocations.shift();n.addChainResults.set(e.chainId,s);break}case"add-chain-result":{n.addChainResults.get(e.chainId)(e),n.addChainResults.delete(e.chainId);break}case"json-rpc-responses-non-empty":{const s=n.chains.get(e.chainId).jsonRpcResponsesPromises;for(;s.length!==0;)s.shift()();break}case"new-connection":{const s=e.connectionId;n.connections.set(s,d.connect({address:e.address,onConnectionReset(c){if(n.instance.status!=="ready")throw new Error;n.connections.delete(s),n.instance.instance.connectionReset(s,c)},onMessage(c,i){if(n.instance.status!=="ready")throw new Error;n.instance.instance.streamMessage(s,c,i)},onStreamOpened(c,i){if(n.instance.status!=="ready")throw new Error;n.instance.instance.streamOpened(s,c,i)},onMultistreamHandshakeInfo(c){if(n.instance.status!=="ready")throw new Error;n.instance.instance.connectionMultiStreamSetHandshakeInfo(s,c)},onWritableBytes(c,i){if(n.instance.status!=="ready")throw new Error;n.instance.instance.streamWritableBytes(s,c,i)},onStreamReset(c,i){if(n.instance.status!=="ready")throw new Error;n.instance.instance.streamReset(s,c,i)}}));break}case"connection-reset":{n.connections.get(e.connectionId).reset(),n.connections.delete(e.connectionId);break}case"connection-stream-open":{n.connections.get(e.connectionId).openOutSubstream();break}case"connection-stream-reset":{n.connections.get(e.connectionId).reset(e.streamId);break}case"stream-send":{n.connections.get(e.connectionId).send(e.data,e.streamId);break}case"stream-send-close":{n.connections.get(e.connectionId).closeSend(e.streamId);break}}},t=a.portToWorker;return t?n.instance={status:"not-ready",whenReady:O({wasmModule:r.then(e=>e.wasm),forbidTcp:a.forbidTcp||!1,forbidWs:a.forbidWs||!1,forbidNonLocalWs:a.forbidNonLocalWs||!1,forbidWss:a.forbidWss||!1,forbidWebRtc:a.forbidWebRtc||!1,maxLogLevel:a.maxLogLevel||3,cpuRateLimit:h,portToServer:t,eventCallback:l}).then(e=>{n.instance.status!=="destroyed"&&(n.instance={status:"ready",instance:e})})}:n.instance={status:"not-ready",whenReady:r.then(e=>L({forbidTcp:a.forbidTcp||!1,forbidWs:a.forbidWs||!1,forbidNonLocalWs:a.forbidNonLocalWs||!1,forbidWss:a.forbidWss||!1,forbidWebRtc:a.forbidWebRtc||!1,maxLogLevel:a.maxLogLevel||3,cpuRateLimit:h,envVars:[],performanceNow:d.performanceNow,getRandomValues:d.getRandomValues},e.wasm,l)).then(e=>{n.instance.status!=="destroyed"&&(n.instance={status:"ready",instance:e})})},{addChain:e=>C(this,void 0,void 0,function*(){if(n.instance.status==="not-ready"&&(yield n.instance.whenReady),n.instance.status==="destroyed")throw n.instance.error;if(n.instance.status==="not-created"||n.instance.status==="not-ready")throw new Error;if(typeof e.chainSpec!="string")throw new Error("Chain specification must be a string");let s=[];if(e.potentialRelayChains)for(const w of e.potentialRelayChains){const y=n.chainIds.get(w);y!==void 0&&s.push(y)}let c=e.jsonRpcMaxPendingRequests===void 0?1/0:e.jsonRpcMaxPendingRequests;if(c=Math.floor(c),c<=0||isNaN(c))throw new R("Invalid value for `jsonRpcMaxPendingRequests`");c>4294967295&&(c=4294967295);let i=e.jsonRpcMaxSubscriptions===void 0?1/0:e.jsonRpcMaxSubscriptions;if(i=Math.floor(i),i<0||isNaN(i))throw new R("Invalid value for `jsonRpcMaxSubscriptions`");if(i>4294967295&&(i=4294967295),e.databaseContent!==void 0&&typeof e.databaseContent!="string")throw new R("`databaseContent` is not a string");const u=new Promise(w=>n.addChainIdAllocations.push(w));n.instance.instance.addChain(e.chainSpec,e.databaseContent||"",s,!!e.disableJsonRpc,c,i);const f=yield u;if(!f.success)throw new R(f.error);const p=f.chainId;n.chains.set(p,{jsonRpcResponsesPromises:new Array});const m={sendJsonRpc:w=>{if(n.instance.status==="destroyed")throw n.instance.error;if(n.instance.status!=="ready")throw new Error;if(!n.chains.has(p))throw new x;if(e.disableJsonRpc)throw new S;const y=n.instance.instance.request(w,p);switch(y){case 0:break;case 1:throw new T;default:throw new Error("Internal error: unknown json_rpc_send error code: "+y)}},jsonRpcResponses:{next:()=>C(this,void 0,void 0,function*(){for(;;){if(!n.chains.has(p))return{done:!0,value:void 0};if(e.disableJsonRpc)throw new S;if(n.instance.status==="destroyed")throw n.instance.error;if(n.instance.status!=="ready")throw new Error;const w=n.instance.instance.peekJsonRpcResponse(p);if(w)return{done:!1,value:w};yield new Promise(y=>{n.chains.get(p).jsonRpcResponsesPromises.push(y)})}}),[Symbol.asyncIterator](){return this}},nextJsonRpcResponse:()=>C(this,void 0,void 0,function*(){const w=yield m.jsonRpcResponses.next();if(w.done)throw new x;return w.value}),remove:()=>{if(n.instance.status==="destroyed")throw n.instance.error;if(n.instance.status!=="ready")throw new Error;if(!n.chains.has(p))throw new x;console.assert(n.chainIds.has(m)),n.chainIds.delete(m);for(const w of n.chains.get(p).jsonRpcResponsesPromises)w();n.chains.delete(p),n.instance.instance.removeChain(p)}};return n.chainIds.set(m,p),m}),terminate:()=>C(this,void 0,void 0,function*(){if(n.instance.status==="not-ready"&&(yield n.instance.whenReady),n.instance.status==="destroyed")throw n.instance.error;if(n.instance.status!=="ready")throw new Error;n.instance.instance.shutdownExecutor(),yield new Promise(e=>n.onExecutorShutdownOrWasmPanic=e),n.instance.status==="ready"&&(n.instance={status:"destroyed",error:new x}),n.connections.forEach(e=>e.reset()),n.connections.clear();for(const e of n.addChainIdAllocations)e({success:!1,error:"Client.terminate() has been called"});n.addChainIdAllocations=[],n.addChainResults.forEach(e=>{e({success:!1,error:"Client.terminate() has been called"})}),n.addChainResults.clear();for(const e of Array.from(n.chains.values())){for(const s of e.jsonRpcResponsesPromises)s();e.jsonRpcResponsesPromises=[]}n.chains.clear()})}}var W=function(a,r,d,o){function h(n){return n instanceof d?n:new d(function(l){l(n)})}return new(d||(d=Promise))(function(n,l){function t(c){try{s(o.next(c))}catch(i){l(i)}}function e(c){try{s(o.throw(c))}catch(i){l(i)}}function s(c){c.done?n(c.value):h(c.value).then(t,e)}s((o=o.apply(a,[])).next())})};function U(a){if(a.forbidTcp=!0,typeof isSecureContext=="boolean"&&isSecureContext&&typeof location!==void 0){const r=location.toString();r.indexOf("localhost")!==-1&&r.indexOf("127.0.0.1")!==-1&&r.indexOf("::1")!==-1&&(a.forbidNonLocalWs=!0)}return B(a,a.bytecode,{performanceNow:()=>performance.now(),getRandomValues:r=>{const d=globalThis.crypto;if(!d)throw new Error("randomness not available");if(r.buffer instanceof ArrayBuffer)d.getRandomValues(r);else{const o=new Uint8Array(r.length);d.getRandomValues(o),r.set(o)}},connect:r=>N(r)})}function N(a){if(a.address.ty==="websocket"){let r;try{r=new WebSocket(a.address.url)}catch(h){r=h instanceof Error?h.toString():"Exception thrown by new WebSocket"}const d={quenedUnreportedBytes:0,nextTimeout:10},o=()=>{if(!(r instanceof WebSocket)||r.readyState!=1)return;const h=r.bufferedAmount;let n=d.quenedUnreportedBytes-h;n<0&&(n=0),d.quenedUnreportedBytes-=n,d.quenedUnreportedBytes!=0&&(setTimeout(o,d.nextTimeout),d.nextTimeout*=2,d.nextTimeout>500&&(d.nextTimeout=500)),n!=0&&a.onWritableBytes(n)};return r instanceof WebSocket?(r.binaryType="arraybuffer",r.onopen=()=>{a.onWritableBytes(1024*1024)},r.onclose=h=>{const n="Error code "+h.code+(h.reason?": "+h.reason:"");a.onConnectionReset(n)},r.onmessage=h=>{a.onMessage(new Uint8Array(h.data))}):setTimeout(()=>{r&&!(r instanceof WebSocket)&&(a.onConnectionReset(r),r=null)},1),{reset:()=>{r instanceof WebSocket&&(r.onopen=null,r.onclose=null,r.onmessage=null,r.onerror=null,r.readyState==WebSocket.OPEN&&r.close()),r=null},send:h=>{d.quenedUnreportedBytes==0&&(d.nextTimeout=10,setTimeout(o,10));for(const n of h)d.quenedUnreportedBytes+=n.length;r.send(new Blob(h))},closeSend:()=>{throw new Error("Wrong connection type")},openOutSubstream:()=>{throw new Error("Wrong connection type")}}}else if(a.address.ty==="webrtc"){const{targetPort:r,ipVersion:d,targetIp:o,remoteTlsCertificateSha256:h}=a.address,n={pc:void 0,dataChannels:new Map,nextStreamId:0,isFirstOutSubstream:!0},l=()=>{if(!n.pc){console.assert(n.dataChannels.size===0,"substreams exist while pc is undef"),n.pc=null;return}n.pc.onconnectionstatechange=null,n.pc.onnegotiationneeded=null,n.pc.ondatachannel=null;for(const e of Array.from(n.dataChannels.values()))e.channel.onopen=null,e.channel.onerror=null,e.channel.onclose=null,e.channel.onbufferedamountlow=null,e.channel.onmessage=null;n.dataChannels.clear(),n.pc.close()},t=(e,s)=>{const c=n.nextStreamId;n.nextStreamId+=1,e.binaryType="arraybuffer";let i={value:!1};e.onopen=()=>{console.assert(!i.value,"substream opened twice"),i.value=!0,a.onStreamOpened(c,s),a.onWritableBytes(65536,c)},e.onerror=e.onclose=u=>{const f=u instanceof RTCErrorEvent?u.error.toString():"RTCDataChannel closed";i.value?(e.onopen=null,e.onerror=null,e.onclose=null,e.onbufferedamountlow=null,e.onmessage=null,n.dataChannels.delete(c),a.onStreamReset(c,f)):(l(),a.onConnectionReset("data channel failed to open: "+f))},e.onbufferedamountlow=()=>{const u=n.dataChannels.get(c),f=u.bufferedBytes;u.bufferedBytes=0,a.onWritableBytes(f,c)},e.onmessage=u=>{a.onMessage(new Uint8Array(u.data),c)},n.dataChannels.set(c,{channel:e,bufferedBytes:0})};return RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:"SHA-256"}).then(e=>W(this,void 0,void 0,function*(){if(n.pc===null)return;if((o=="localhost"||o=="127.0.0.1"||o=="::1")&&navigator.userAgent.indexOf("Firefox")!==-1){l(),a.onConnectionReset("Firefox can't connect to a localhost WebRTC server");return}n.pc=new RTCPeerConnection({certificates:[e]});let s;if(e.getFingerprints){for(const{algorithm:i,value:u}of e.getFingerprints())if(i==="sha-256"){s=u;break}}else{const i=(yield n.pc.createOffer()).sdp.match(/a(\s*)=(\s*)fingerprint:(\s*)(sha|SHA)-256(\s*)(([a-fA-F0-9]{2}(:)*){32})/);i&&(s=i[6])}if(s===void 0){a.onConnectionReset("Failed to obtain the browser certificate fingerprint");return}let c=new Uint8Array(32);c.set(s.split(":").map(i=>parseInt(i,16)),0),n.pc.onconnectionstatechange=i=>{(n.pc.connectionState=="closed"||n.pc.connectionState=="disconnected"||n.pc.connectionState=="failed")&&(l(),a.onConnectionReset("WebRTC state transitioned to "+n.pc.connectionState))},n.pc.onnegotiationneeded=i=>W(this,void 0,void 0,function*(){var u;let f=(yield n.pc.createOffer()).sdp;f.match(/^m=application(\s+)(\d+)(\s+)UDP\/DTLS\/SCTP(\s+)webrtc-datachannel$/m)===null&&console.error("Local offer doesn't contain UDP data channel. WebRTC connections will likely fail. Please report this issue.");const p=(u=f.match(/^a=ice-pwd:(.+)$/m))===null||u===void 0?void 0:u.at(1);p===void 0&&console.error("Failed to set ufrag to pwd. WebRTC connections will likely fail. Please report this issue.");const m="libp2p+webrtc+v1/"+p;f=f.replace(/^a=ice-ufrag.*$/m,"a=ice-ufrag:"+m),f=f.replace(/^a=ice-pwd.*$/m,"a=ice-pwd:"+m),yield n.pc.setLocalDescription({type:"offer",sdp:f});const w=Array.from(h).map(P=>("0"+P.toString(16)).slice(-2).toUpperCase()).join(":"),y=`v=0
o=- 0 0 IN IP`+d+" "+o+`
s=-
t=0 0
a=ice-lite
m=application `+String(r)+` UDP/DTLS/SCTP webrtc-datachannel
c=IN IP`+d+" "+o+`
a=mid:0
a=ice-options:ice2
a=ice-ufrag:`+m+`
a=ice-pwd:`+m+`
a=fingerprint:sha-256 `+w+`
a=setup:passive
a=sctp-port:5000
a=max-message-size:16384
a=candidate:1 1 UDP 1 `+o+" "+String(r)+` typ host
`;yield n.pc.setRemoteDescription({type:"answer",sdp:y})}),n.pc.ondatachannel=({channel:i})=>{t(i,"inbound")},a.onMultistreamHandshakeInfo({handshake:"webrtc",localTlsCertificateSha256:c})})),{reset:e=>{if(e===void 0)l();else{const s=n.dataChannels.get(e);s.channel.onopen=null,s.channel.onerror=null,s.channel.onclose=null,s.channel.onbufferedamountlow=null,s.channel.onmessage=null,s.channel.close(),n.dataChannels.delete(e)}},send:(e,s)=>{const c=n.dataChannels.get(s);for(const i of e)c.bufferedBytes+=i.length;c.channel.send(new Blob(e))},closeSend:()=>{throw new Error("Wrong connection type")},openOutSubstream:()=>{const e=n.isFirstOutSubstream?{negotiated:!0,id:0}:{};n.isFirstOutSubstream=!1,t(n.pc.createDataChannel("",e),"outbound")}}}else throw new Error}export{R as AddChainError,x as AlreadyDestroyedError,_ as CrashError,S as JsonRpcDisabledError,T as QueueFullError,U as startWithBytecode};
